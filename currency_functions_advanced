<?php
/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç —Å —Å–∞–π—Ç–∞ –¶–ë –†–§
 *
 * @param array $config –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   - cache_file (string) - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫—ç—à–∞
 *   - cache_time (int) - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
 *   - currencies (array) - –º–∞—Å—Å–∏–≤ –≤–∞–ª—é—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫–æ–¥—ã –∏ –¥–∞–Ω–Ω—ã–µ)
 * @return string HTML-–∫–æ–¥ —Å —Ç–∞–±–ª–∏—Ü–µ–π –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
  */

   // –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º $config (–º–∞—Å—Å–∏–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
   function get_currency_rates_2(array $config = [])
 {

   /*****************************************************************
   * –ë–õ–û–ö 1: –£–°–¢–ê–ù–û–í–ö–ê –ó–ù–ê–ß–ï–ù–ò–ô –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
   *****************************************************************/

   // –ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    $defaults = [
      // –§–∞–π–ª –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ —Å–∫—Ä–∏–ø—Ç)
      'cache_file' => __DIR__ . '/currency_cache.json',

      // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –≤ —á–∞—Å–∞—Ö
      'cache_time' => 3600, // 1 —á–∞—Å

      // –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –≤–∞–ª—é—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
      'currencies' => [
        'USD' => ['name' => '–î–æ–ª–ª–∞—Ä –°–®–ê', 'flag' => 'üá∫üá∏'],
        'EUR' => ['name' => '–ï–≤—Ä–æ', 'flag' => 'üá™üá∫'],
        'GBP' => ['name' => '–§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤', 'flag' => 'üá¨üáß'],
        'CNY' => ['name' => '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å', 'flag' => 'üá®üá≥'],
        'JPY' => ['name' => '–Ø–ø–æ–Ω—Å–∫–∞—è –∏–µ–Ω–∞', 'flag' => 'üáØüáµ'],
        'CAD' => ['name' => '–ö–∞–Ω–∞–¥—Å–∫–∏–π –¥–æ–ª–ª–∞—Ä', 'flag' => 'üá®üá¶'],
        'IDR' => ['name' => '–ò–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∞—è —Ä—É–ø–∏—è', 'flag' => 'üáÆüá©'],
        'INR' => ['name' => '–ò–Ω–¥–∏–π—Å–∫–∞—è —Ä—É–ø–∏—è', 'flag' => 'üáÆüá≥'],
        'BRL' => ['name' => '–ë—Ä–∞–∑–∏–ª—å—Å–∫–∏–π —Ä–µ–∞–ª', 'flag' => 'üáßüá∑'],
        'KRW' => ['name' => '–Æ–∂–Ω–æ–∫–æ—Ä–µ–π—Å–∫–∞—è –≤–æ–Ω–∞', 'flag' => 'üá∞üá∑'],
        'ZAR' => ['name' => '–Æ–∂–Ω–æ–∞—Ñ—Ä–∏–∫–∞–Ω—Å–∫–∏–π —Ä—ç–Ω–¥', 'flag' => 'üáøüá¶'],
        'SGD' => ['name' => '–°–∏–Ω–≥–∞–ø—É—Ä—Å–∫–∏–π –¥–æ–ª–ª–∞—Ä', 'flag' => 'üá∏üá¨']
        ]
        ];

         // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
         // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
         $config = array_merge($defaults, $config);

         /*****************************************************************
         * –ë–õ–û–ö 2: –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ö–£–†–°–û–í –í–ê–õ–Æ–¢
         *****************************************************************/

         // –û–±—ä—è–≤–ª—è–µ–º –∞–Ω–æ–Ω–∏–º–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç

         $parse_currency_rates = function() use ($config)
         {
               // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫—É—Ä—Å–æ–≤ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
               $url = 'https://www.cbr.ru/scripts/XML_daily.asp?date_req=' . date('d/m/Y');
           try
          {
            /*********************************************************
            * –ë–õ–û–ö 2.1: –ù–ê–°–¢–†–û–ô–ö–ò HTTP-–ó–ê–ü–†–û–°–ê
            *********************************************************/

             // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–∞
             $options = [
                'http' => [
                'method' => 'GET',       // –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
                'timeout' => 15,         // –¢–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                'header' => "User-Agent: Mozilla/5.0\r\n" // –ó–∞–≥–æ–ª–æ–≤–æ–∫ User-Agent
                ]
             ];

             // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Ç–æ–∫–∞ —Å –Ω–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
             $context = stream_context_create($options);

              /*********************************************************
              * –ë–õ–û–ö 2.2: –í–´–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–ü–†–û–°–ê
              *********************************************************/

              // –ü–æ–ª—É—á–∞–µ–º XML-–¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¶–ë
              $xml = file_get_contents($url, false, $context);

              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
               if ($xml === false)
              {
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É PHP
                $error = error_get_last();
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏
                throw new Exception("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " . ($error['message'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              }

              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
              if (empty($xml))
             {
               throw new Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
             }

              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ XML (–µ—Å—Ç—å –ª–∏ —Ç–µ–≥–∏ Valute)
              if (strpos($xml, '<Valute') === false)
            {
              throw new Exception("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç XML");
            }
              $pattern = '/<Valute\b[^>]*>               # –ù–∞—á–∞–ª–æ —Ç–µ–≥–∞ <Valute> (–≤–æ–∑–º–æ–∂–Ω—ã –∞—Ç—Ä–∏–±—É—Ç—ã)
                .*?                         # –õ–µ–Ω–∏–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ª—é–±—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                <CharCode>                  # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã
                (USD|EUR|GBP|CNY|JPY|CAD|IDR|INR|BRL|KRW|ZAR|SGD)  # –ì—Ä—É–ø–ø–∞ 1: ISO-–∫–æ–¥—ã –≤–∞–ª—é—Ç (USD, EUR –∏ —Ç.–¥.)
                <\/CharCode>                # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥
                .*?                         # –õ–µ–Ω–∏–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ª—é–±—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                <Value>                     # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –∑–Ω–∞—á–µ–Ω–∏—è
                ([\d,]+)                    # –ì—Ä—É–ø–ø–∞ 2: –ß–∏—Å–ª–æ —Å –∑–∞–ø—è—Ç—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "63,4245")
                <\/Value>                   # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥
                /xis';                      # –§–ª–∞–≥–∏: x-—á–∏—Ç–∞–µ–º–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏,
                                            # i-–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç–µ–≥–∏ –≤ XML –±—É–¥—É—Ç –≤ –¥—Ä—É–≥–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (<CHARCODE>),
                                            # s-—á—Ç–æ–±—ã . –º–æ–≥–ª–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏, —Ç–æ—á–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç \n

              // –ü–∞—Ä—Å–∏–º XML —Å –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç –∏—Å–ø–æ–ª—å–∑—É—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
              // $pattern - —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–∞–ª—é—Ç–∞—Ö
              // $matches - –º–∞—Å—Å–∏–≤ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞
              // PREG_SET_ORDER - –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –≤–∞–ª—é—Ç–µ
              preg_match_all($pattern, $xml, $matches, PREG_SET_ORDER);

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω—ã –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤–∞–ª—é—Ç–∞—Ö
              if (empty($matches))
             {
               // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
               throw new Exception("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –≤–∞–ª—é—Ç–∞—Ö –≤ XML");
             }

               // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
               $rates = [];

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
              foreach ($matches as $match)
              {
                // $match[1] - —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–¥ –≤–∞–ª—é—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, USD, EUR)
               // $match[2] - —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ (—Å –∑–∞–ø—è—Ç–æ–π –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è)
               // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ —Ç–∏–ø–∞ float
                $rates[$match[1]] = (float)str_replace(',', '.', $match[2]);
              }

               // –°–ø–∏—Å–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∞–ª—é—Ç, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
                $required = ['USD', 'EUR'];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∞–ª—é—Ç
                foreach ($required as $currency)
                {
                  if (!isset($rates[$currency]))
                  {
                    // –ï—Å–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –≤–∞–ª—é—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                    throw new Exception("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫—É—Ä—Å $currency");
                  }
                }

                 // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ –º–∞—Å—Å–∏–≤–∞:
                 // 'rates' - –º–∞—Å—Å–∏–≤ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
                 // 'updated_at' - –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                 // 'error' - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ (null)
            return [
              'rates' => $rates,
              'updated_at' => time(),
              'error' => null
             ];

          } catch (Exception $e)
           {
              // –í —Å–ª—É—á–∞–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º:
              // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∫—É—Ä—Å–æ–≤
              // –¢–µ–∫—É—â—É—é –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
              // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
             return [
              'rates' => [],
              'updated_at' => time(),
              'error' => $e->getMessage()
             ];
           }
         };

         /************************************************************
          * –†–ê–ë–û–¢–ê –° –ö–≠–®–ï–ú
         ************************************************************/

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      $data = [];

      // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫—ç—à
      $useCache = false;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –∫—ç—à–∞ –∏ –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –æ–Ω
      // file_exists - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
      // filemtime - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
      // $config['cache_time'] - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –≤ —á–∞—Å–∞—Ö
       if (file_exists($config['cache_file']) &&
          (time() - filemtime($config['cache_file']) < $config['cache_time']))
      {

        // –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∫—ç—à–∞ –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º JSON
        $cached = json_decode(file_get_contents($config['cache_file']), true);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º:
        // 1. –ß—Ç–æ JSON –±—ã–ª —É—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω (json_last_error() === JSON_ERROR_NONE)
        // 2. –ß—Ç–æ –≤ –∫—ç—à–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫—É—Ä—Å–∞—Ö –≤–∞–ª—é—Ç
        if (json_last_error() === JSON_ERROR_NONE && !empty($cached['rates']))
        {
          $data = $cached;
          $useCache = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞
        }
      }

        // –ï—Å–ª–∏ –∫—ç—à –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (—É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω)
        if (!$useCache)
        {
          // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
          $data = $parse_currency_rates();

          // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
          if (empty($data['error']))
          {
            // file_put_contents - –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
            // json_encode - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–∞—Å—Å–∏–≤ –≤ JSON
            // LOCK_EX - —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
            file_put_contents($config['cache_file'], json_encode($data), LOCK_EX);
          }
        }

      /************************************************************
      * –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML
      ************************************************************/

     // –í–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞
     // ob_start - –Ω–∞—á–∏–Ω–∞–µ—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞, –≤–µ—Å—å –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –≤—ã–≤–æ–¥ –±—É–¥–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –≤ –±—É—Ñ–µ—Ä–µ
     // –≤–º–µ—Å—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä
     ob_start();
     ?>

    <!DOCTYPE html>
  <html>
    <head>
        <title>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</title>
        <meta charset="UTF-8">

        <style>
            /* [1] –û–ë–©–ò–ô –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –í–°–ï–ì–û –í–ò–î–ñ–ï–¢–ê */
            /* –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –≤—Å–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç */
            .currency-widget {
                position: fixed;        /* –§–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
                bottom: 20px;          /* –û—Ç—Å—Ç—É–ø –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ */
                right: 20px;            /* –û—Ç—Å—Ç—É–ø –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ */
                max-width: 300px;      /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≤–∏–¥–∂–µ—Ç–∞ */
                height: auto;         /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
                max-height: 400px;    /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
                overflow-y: auto;     /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
                z-index: 1000;         /* –ü–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
                background: #f9f9f9;   /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ */
                border: 1px solid #e0e0e0; /* –ì—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–∂–µ—Ç–∞ */
                border-radius: 5px;    /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */
                padding: 10px;         /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
                box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* –¢–µ–Ω—å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è */
                cursor: grab; /* –ö—É—Ä—Å–æ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
                user-select: none; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
                transition: box-shadow 0.2s; /* –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–Ω–∏ */
            }

            .currency-widget:active {
                cursor: grabbing; /* –ö—É—Ä—Å–æ—Ä –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
            }

            /* [2] –°–¢–ò–õ–ò –ó–ê–ì–û–õ–û–í–ö–ê –í–ò–î–ñ–ï–¢–ê */
            .header {
                text-align: left;      /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
                margin-bottom: 8px;    /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
                font-size: 13px;       /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* [3] –°–¢–ò–õ–ò –°–ü–ò–°–ö–ê –í–ê–õ–Æ–¢ */
            .currency-list {
                margin: 0;             /* –£–±–∏—Ä–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
                padding: 0;            /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            }

            /* [4] –°–¢–ò–õ–ò –û–¢–î–ï–õ–¨–ù–û–ô –í–ê–õ–Æ–¢–´ –í –°–ü–ò–°–ö–ï */
            .currency-item {
                display: flex;         /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex-—Ä–∞—Å–∫–ª–∞–¥–∫—É */
                align-items: center;   /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
                padding: 5px;          /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
                border-bottom: 1px solid #eee; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
                font-size: 0.9em;      /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* –£–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
            .currency-item:last-child {
                border-bottom: none;
            }

            /* [5] –°–¢–ò–õ–ò –î–õ–Ø –§–õ–ê–ì–ê –í–ê–õ–Æ–¢–´ */
            .currency-flag {
                margin-right: 8px;    /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
                font-size: 20px;      /* –†–∞–∑–º–µ—Ä emoji-—Ñ–ª–∞–≥–æ–≤ */
                width: 24px;          /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
                text-align: center;   /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
            }

            /* [6] –°–¢–ò–õ–ò –î–õ–Ø –ù–ê–ó–í–ê–ù–ò–Ø –í–ê–õ–Æ–¢–´ */
            .currency-name {
                flex-grow: 1;         /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
                white-space: nowrap;  /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
                overflow: hidden;     /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ */
                text-overflow: ellipsis; /* –î–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ */
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã –≤ —Å–∫–æ–±–∫–∞—Ö */
            .currency-name small {
                color: #777;          /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç */
                font-size: 0.8em;     /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* [7] –°–¢–ò–õ–ò –î–õ–Ø –ó–ù–ê–ß–ï–ù–ò–Ø –ö–£–†–°–ê */
            .currency-rate {
                font-weight: bold;    /* –ü–æ–ª—É–∂–∏—Ä–Ω–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ */
                margin-left: 10px;    /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
                white-space: nowrap;  /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
                color: #2a6496;       /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç */
            }

            /* [8] –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ö–≠–®–ò–†–û–í–ê–ù–ò–ò */
            .cache-info {
                text-align: left;     /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
                color: #666;          /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
                margin-top: 10px;     /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
                font-size: 0.8em;    /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* [9] –°–¢–ò–õ–ò –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô –û–ë –û–®–ò–ë–ö–ê–• */
            .empty-message, .error-message {
                text-align: left;     /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
                color: #d9534f;      /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –æ—à–∏–±–æ–∫ */
                padding: 10px;       /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
                font-size: 0.9em;    /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }
        </style>
    </head>
   <body>

     <?php
      /*
         echo '<pre>';
         print_r($data['rates']); // –ø—Ä–æ–≤–µ—Ä–∫–∞ API –¶–ë –†–§ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ª–∏ –∫—É—Ä—Å –¥–ª—è —ç—Ç–æ–π –≤–∞–ª—é—Ç—ã.
         echo '</pre>';
      */
     ?>

      <!-- [10] –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –°–¢–†–ê–ù–ò–¶–´ (–±—É–¥–µ—Ç —Å–∫—Ä–æ–ª–∏—Ç—å—Å—è) -->
      <!-- –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->

      <!-- [11] –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –í–ò–î–ñ–ï–¢ –ö–£–†–°–û–í –í–ê–õ–Æ–¢ -->
     <div class="currency-widget" id="draggable-widget">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∏–¥–∂–µ—Ç–∞ -->
        <div class="header">
            <h1>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</h1>
            <p>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –Ω–∞ <?= date('d.m.Y') ?></p>
        </div>

        <?php
          // [12] –ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –î–ê–ù–ù–´–• –û –ö–£–†–°–ê–•
          if (!empty($data['rates'])):
        ?>
            <?php
              // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
              asort($data['rates']);
            ?>

            <!-- –°–ø–∏—Å–æ–∫ –≤–∞–ª—é—Ç -->
            <div class="currency-list">
                <?php foreach ($data['rates'] as $code => $rate): ?>
                    <?php if (isset($config['currencies'][$code])): ?>
                        <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞ -->
                        <div class="currency-item">
                            <!-- –§–ª–∞–≥ –≤–∞–ª—é—Ç—ã -->
                            <span class="currency-flag"><?= $config['currencies'][$code]['flag'] ?></span>

                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥ –≤–∞–ª—é—Ç—ã -->
                            <span class="currency-name">
                              <?= htmlspecialchars($config['currencies'][$code]['name']) ?>
                              <small>(<?= htmlspecialchars($code) ?>)</small>
                            </span>

                            <!-- –ó–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ -->
                            <span class="currency-rate">
                              <?= number_format($rate, 2) ?> —Ä—É–±.
                            </span>
                        </div>
                    <?php endif; ?>
                  <?php endforeach; ?>
                </div>

                 <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ -->
                <p class="cache-info">
                  –û–±–Ω–æ–≤–ª–µ–Ω–æ: <?= date('H:i:s', $data['updated_at']) ?>
                  <?= $useCache ? '(–∏–∑ –∫—ç—à–∞)' : '(–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)' ?>
                </p>
               <?php else: ?>
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
               <p class="empty-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç.</p>
               <?php endif; ?>

               <?php if (!empty($data['error'])): ?>
               <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
               <p class="error-message">–û—à–∏–±–∫–∞: <?= htmlspecialchars($data['error']) ?></p>
               <?php endif; ?>
            </div>

       <script>

            // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM-–¥–µ—Ä–µ–≤–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Å–∫—Ä–∏–ø—Ç–∞
          document.addEventListener('DOMContentLoaded', function()
          {
            // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π –≤–∏–¥–∂–µ—Ç –ø–æ –µ–≥–æ ID
            const widget = document.getElementById('draggable-widget');

            // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            let isDragging = false;

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–º–µ—â–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            let offsetX, offsetY;

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ Y –∏ –≤—ã—Å–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
            let startY, widgetHeight;

             // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏ –Ω–∞ –≤–∏–¥–∂–µ—Ç–µ (–Ω–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è)
              widget.addEventListener
                  ('mousedown', function(e)
               {
                     // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≤ true
                     isDragging = true;

                     // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ –≤–∏–¥–∂–µ—Ç–∞:
                     // e.clientX/Y - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞ –≤ –º–æ–º–µ–Ω—Ç –∫–ª–∏–∫–∞
                     // widget.getBoundingClientRect().left/top - –ø–æ–∑–∏—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
                     offsetX = e.clientX - widget.getBoundingClientRect().left;
                     offsetY = e.clientY - widget.getBoundingClientRect().top;

                     // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é Y (–¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è)
                     startY = e.clientY;

                     // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É –≤–∏–¥–∂–µ—Ç–∞ (—á—Ç–æ–±—ã –æ–Ω –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª—Å—è)
                     widgetHeight = widget.offsetHeight;

                     // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ "grabbing" (–∑–∞–∫—Ä—ã—Ç–∞—è —Ä—É–∫–∞) –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
                     widget.style.cursor = 'grabbing';

                     // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–µ–Ω—å –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–ø–æ–¥–Ω—è—Ç–∏—è"
                     widget.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';

                      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞)
                      e.preventDefault();
               }   );

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É (—Å–∞–º–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ)
                    document.addEventListener
                    ('mousemove', function(e)
                 {
                       // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ - –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
                       if (!isDragging) return;

                       // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é X:
                       // e.clientX - —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ –ø–æ X
                       // offsetX - —Å–º–µ—â–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∂–µ—Ç–∞
                       const x = e.clientX - offsetX;

                       // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é Y —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏:
                       // Math.min –≤—ã–±–∏—Ä–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
                       // 1. e.clientY - offsetY - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ Y
                       // 2. window.innerHeight - widgetHeight - 20 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (–≤—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞ –º–∏–Ω—É—Å –≤—ã—Å–æ—Ç–∞ –≤–∏–¥–∂–µ—Ç–∞ –∏ 20px –æ—Ç—Å—Ç—É–ø)
                        const y = Math.min
                       (
                         e.clientY - offsetY,
                         window.innerHeight - widgetHeight - 20
                       );

                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫ –≤–∏–¥–∂–µ—Ç—É
                        widget.style.left = x + 'px';
                        widget.style.top = y + 'px';
                 }   );

                 // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏ (–∫–æ–Ω–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è)
                document.addEventListener
                  ('mouseup', function()
                {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    isDragging = false;

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "grab" (–æ—Ç–∫—Ä—ã—Ç–∞—è —Ä—É–∫–∞)
                    widget.style.cursor = 'grab';

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–Ω—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
                    widget.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                } );

                   // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä "grab" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                   widget.style.cursor = 'grab';
          } );

        </script>

    </body>
  </html>
        <?php
        // [13] –í–û–ó–í–†–ê–©–ê–ï–ú –°–û–ë–†–ê–ù–ù–´–ô HTML
        return ob_get_clean();
}
        ?>

