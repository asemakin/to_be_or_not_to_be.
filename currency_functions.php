<?php
/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç —Å —Å–∞–π—Ç–∞ –¶–ë –†–§
 *
 * @param array $config –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   - cache_file (string) - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫—ç—à–∞
 *   - cache_time (int) - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
 *   - currencies (array) - –º–∞—Å—Å–∏–≤ –≤–∞–ª—é—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫–æ–¥—ã –∏ –¥–∞–Ω–Ω—ã–µ)
 * @return string HTML-–∫–æ–¥ —Å —Ç–∞–±–ª–∏—Ü–µ–π –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
 */

// –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º $config (–º–∞—Å—Å–∏–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
 function get_currency_rates(array $config = [])
 {

    /*****************************************************************
     * –ë–õ–û–ö 1: –£–°–¢–ê–ù–û–í–ö–ê –ó–ù–ê–ß–ï–ù–ò–ô –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
     *****************************************************************/

    // –ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    $defaults = [
        // –§–∞–π–ª –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ —Å–∫—Ä–∏–ø—Ç)
        'cache_file' => __DIR__ . '/currency_cache.json',

        // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –≤ —á–∞—Å–∞—Ö
        'cache_time' => 3600, // 1 —á–∞—Å

        // –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –≤–∞–ª—é—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        'currencies' => [
            'USD' => ['name' => '–î–æ–ª–ª–∞—Ä –°–®–ê', 'flag' => 'üá∫üá∏'],
            'EUR' => ['name' => '–ï–≤—Ä–æ', 'flag' => 'üá™üá∫'],
            'GBP' => ['name' => '–§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤', 'flag' => 'üá¨üáß'],
            'CNY' => ['name' => '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å', 'flag' => 'üá®üá≥'],
            'JPY' => ['name' => '–Ø–ø–æ–Ω—Å–∫–∞—è –∏–µ–Ω–∞', 'flag' => 'üáØüáµ'],
            'CAD' => ['name' => '–ö–∞–Ω–∞–¥—Å–∫–∏–π –¥–æ–ª–ª–∞—Ä', 'flag' => 'üá®üá¶'],
            'IDR' => ['name' => '–ò–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∞—è —Ä—É–ø–∏—è', 'flag' => 'üáÆüá©'],
            'INR' => ['name' => '–ò–Ω–¥–∏–π—Å–∫–∞—è —Ä—É–ø–∏—è', 'flag' => 'üáÆüá≥']
        ]
    ];

    // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    $config = array_merge($defaults, $config);

    /*****************************************************************
     * –ë–õ–û–ö 2: –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ö–£–†–°–û–í –í–ê–õ–Æ–¢
     *****************************************************************/

    // –û–±—ä—è–≤–ª—è–µ–º –∞–Ω–æ–Ω–∏–º–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
    $parse_currency_rates = function() use ($config) {
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫—É—Ä—Å–æ–≤ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
        $url = 'https://www.cbr.ru/scripts/XML_daily.asp?date_req=' . date('d/m/Y');

        try {
            /*********************************************************
             * –ë–õ–û–ö 2.1: –ù–ê–°–¢–†–û–ô–ö–ò HTTP-–ó–ê–ü–†–û–°–ê
             *********************************************************/

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–∞
            $options = [
                'http' => [
                    'method' => 'GET',       // –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
                    'timeout' => 15,         // –¢–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                    'header' => "User-Agent: Mozilla/5.0\r\n" // –ó–∞–≥–æ–ª–æ–≤–æ–∫ User-Agent
                ]
            ];

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Ç–æ–∫–∞ —Å –Ω–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            $context = stream_context_create($options);

            /*********************************************************
             * –ë–õ–û–ö 2.2: –í–´–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–ü–†–û–°–ê
             *********************************************************/

            // –ü–æ–ª—É—á–∞–µ–º XML-–¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¶–ë
            $xml = file_get_contents($url, false, $context);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
            if ($xml === false) {
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É PHP
                $error = error_get_last();
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏
                throw new Exception("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " . ($error['message'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
            if (empty($xml)) {
                throw new Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ XML (–µ—Å—Ç—å –ª–∏ —Ç–µ–≥–∏ Valute)
            if (strpos($xml, '<Valute') === false) {
                throw new Exception("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç XML");
            }
            $pattern = '/<Valute\b[^>]*>               # –ù–∞—á–∞–ª–æ —Ç–µ–≥–∞ <Valute> (–≤–æ–∑–º–æ–∂–Ω—ã –∞—Ç—Ä–∏–±—É—Ç—ã)
               .*?                         # –õ–µ–Ω–∏–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ª—é–±—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
               <CharCode>                  # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã
               (USD|EUR|GBP|CNY|JPY|CAD|IDR|INR)  # –ì—Ä—É–ø–ø–∞ 1: ISO-–∫–æ–¥—ã –≤–∞–ª—é—Ç (USD, EUR –∏ —Ç.–¥.)
               <\/CharCode>                # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥
               .*?                         # –õ–µ–Ω–∏–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ª—é–±—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
               <Value>                     # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –∑–Ω–∞—á–µ–Ω–∏—è
               ([\d,]+)                    # –ì—Ä—É–ø–ø–∞ 2: –ß–∏—Å–ª–æ —Å –∑–∞–ø—è—Ç—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "63,4245")
               <\/Value>                   # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥
               /xis';                      # –§–ª–∞–≥–∏: x-—á–∏—Ç–∞–µ–º–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏,
            # i-–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç–µ–≥–∏ –≤ XML –±—É–¥—É—Ç –≤ –¥—Ä—É–≥–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (<CHARCODE>),
            # s-—á—Ç–æ–±—ã . –º–æ–≥–ª–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏, —Ç–æ—á–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç \n

            // –ü–∞—Ä—Å–∏–º XML —Å –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç –∏—Å–ø–æ–ª—å–∑—É—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
            // $pattern - —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–∞–ª—é—Ç–∞—Ö
            // $matches - –º–∞—Å—Å–∏–≤ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞
            // PREG_SET_ORDER - –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –≤–∞–ª—é—Ç–µ
            preg_match_all($pattern, $xml, $matches, PREG_SET_ORDER);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω—ã –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤–∞–ª—é—Ç–∞—Ö
            if (empty($matches)) {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                throw new Exception("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –≤–∞–ª—é—Ç–∞—Ö –≤ XML");
            }

            // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
            $rates = [];

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
            foreach ($matches as $match) {
                // $match[1] - —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–¥ –≤–∞–ª—é—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, USD, EUR)
                // $match[2] - —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ (—Å –∑–∞–ø—è—Ç–æ–π –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è)
                // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ —Ç–∏–ø–∞ float
                $rates[$match[1]] = (float)str_replace(',', '.', $match[2]);
            }

            // –°–ø–∏—Å–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∞–ª—é—Ç, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
            $required = ['USD', 'EUR'];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∞–ª—é—Ç
            foreach ($required as $currency) {
                if (!isset($rates[$currency])) {
                    // –ï—Å–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –≤–∞–ª—é—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                    throw new Exception("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫—É—Ä—Å $currency");
                }
            }

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ –º–∞—Å—Å–∏–≤–∞:
            // 'rates' - –º–∞—Å—Å–∏–≤ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
            // 'updated_at' - –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            // 'error' - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ (null)
            return [
                'rates' => $rates,
                'updated_at' => time(),
                'error' => null
            ];

        } catch (Exception $e) {
            // –í —Å–ª—É—á–∞–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º:
            // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∫—É—Ä—Å–æ–≤
            // –¢–µ–∫—É—â—É—é –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            return [
                'rates' => [],
                'updated_at' => time(),
                'error' => $e->getMessage()
            ];
        }
    };

    /************************************************************
     * –†–ê–ë–û–¢–ê –° –ö–≠–®–ï–ú
     ************************************************************/

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    $data = [];

    // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫—ç—à
    $useCache = false;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –∫—ç—à–∞ –∏ –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –æ–Ω
    // file_exists - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    // filemtime - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    // $config['cache_time'] - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –≤ —á–∞—Å–∞—Ö
    if (file_exists($config['cache_file']) &&
        (time() - filemtime($config['cache_file']) < $config['cache_time'])) {

        // –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∫—ç—à–∞ –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º JSON
        $cached = json_decode(file_get_contents($config['cache_file']), true);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º:
        // 1. –ß—Ç–æ JSON –±—ã–ª —É—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω (json_last_error() === JSON_ERROR_NONE)
        // 2. –ß—Ç–æ –≤ –∫—ç—à–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫—É—Ä—Å–∞—Ö –≤–∞–ª—é—Ç
        if (json_last_error() === JSON_ERROR_NONE && !empty($cached['rates'])) {
            $data = $cached;
            $useCache = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞
        }
    }

    // –ï—Å–ª–∏ –∫—ç—à –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (—É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω)
    if (!$useCache) {
        // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
        $data = $parse_currency_rates();

        // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
        if (empty($data['error'])) {
            // file_put_contents - –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
            // json_encode - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–∞—Å—Å–∏–≤ –≤ JSON
            // LOCK_EX - —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
            file_put_contents($config['cache_file'], json_encode($data), LOCK_EX);
        }
    }

    /************************************************************
     * –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML
     ************************************************************/

    // –í–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞
    // ob_start - –Ω–∞—á–∏–Ω–∞–µ—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞, –≤–µ—Å—å –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –≤—ã–≤–æ–¥ –±—É–¥–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –≤ –±—É—Ñ–µ—Ä–µ
    // –≤–º–µ—Å—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä
    ob_start();
    ?>

    <!DOCTYPE html>
    <html>
    <head>
        <title>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</title>
        <meta charset="UTF-8">

        <style>
            /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –±–ª–æ–∫–∞ */
            .header {
                text-align: left;    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
                margin-bottom: 8px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
                font-size: 13px;    /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ */
            }

            /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤–∞–ª—é—Ç */
            .currency-list {
                max-width: 280px;    /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –±–ª–æ–∫–∞ */
                margin: 0;           /* –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
                padding: 3px;        /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
                border: 1px solid #e0e0e0;  /* –¢–æ–Ω–∫–∞—è —Å–µ—Ä–∞—è —Ä–∞–º–∫–∞ */
                border-radius: 5px;  /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
                background: #f9f9f9; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            }

            /* –°—Ç–∏–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–∞–ª—é—Ç—ã */
            .currency-item {
                display: flex;       /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex-—Ä–∞—Å–∫–ª–∞–¥–∫—É */
                align-items: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
                padding: 5px 5px;    /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã: 8px —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É, 5px —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ */
                border-bottom: 1px solid #eee;  /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
                font-size: 0.9em;    /* –ß—É—Ç—å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* –£–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
            .currency-item:last-child {
                border-bottom: none;
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–ª–∞–≥–∞ –≤–∞–ª—é—Ç—ã */
            .currency-flag {
                margin-right: 8px;   /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ñ–ª–∞–≥–∞ */
                font-size: 20px;     /* –†–∞–∑–º–µ—Ä emoji-—Ñ–ª–∞–≥–æ–≤ */
                width: 24px;         /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
                text-align: center;  /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ñ–ª–∞–≥ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –≤–∞–ª—é—Ç—ã */
            .currency-name {
                flex-grow: 1;        /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
                white-space: nowrap; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
                overflow: hidden;    /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –≤—ã—Ö–æ–¥—è—â–∏–π –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
                text-overflow: ellipsis; /* –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç —Å –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ–º */
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã –≤ —Å–∫–æ–±–∫–∞—Ö */
            .currency-name small {
                color: #777;         /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–¥–∞ */
                font-size: 0.8em;    /* –ß—É—Ç—å –º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ */
            .currency-rate {
                font-weight: bold;   /* –ü–æ–ª—É–∂–∏—Ä–Ω–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ */
                margin-left: 10px;   /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
                white-space: nowrap; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –∫—É—Ä—Å–∞ */
                color: #2a6496;      /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç –¥–ª—è –∫—É—Ä—Å–∞ */
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–∏ */
            .cache-info {
                text-align: left;    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
                color: #666;         /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
                margin-top: 10px;    /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
                font-size: 0.8em;    /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—É—Å—Ç—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö */
            .empty-message, .error-message {
                text-align: left;    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
                color: #d9534f;     /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –æ—à–∏–±–æ–∫ */
                padding: 10px;      /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
                font-size: 0.9em;   /* –ß—É—Ç—å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            }
        </style>
    </head>
    <body>
    <div class="header">
        <h1>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</h1>
        <p>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –Ω–∞ <?= date('d.m.Y') ?></p>
    </div>

    <?php
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –∫—É—Ä—Å–∞—Ö –≤–∞–ª—é—Ç –≤ –º–∞—Å—Å–∏–≤–µ $data
    if (!empty($data['rates'])): ?>
        <?php
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é (–æ—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É)
        asort($data['rates']); ?>

        <!-- –ù–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤–∞–ª—é—Ç -->
        <div class="currency-list">
            <?php
            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
            foreach ($data['rates'] as $code => $rate): ?>
                <?php
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞–ª—é—Ç–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                if (isset($config['currencies'][$code])): ?>
                    <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∞–ª—é—Ç—ã -->
                    <div class="currency-item">
                        <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–ª–∞–≥ –≤–∞–ª—é—Ç—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
                        <span class="currency-flag"><?= $config['currencies'][$code]['flag'] ?></span>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã –∏ –µ—ë –∫–æ–¥ -->
                        <span class="currency-name">
                        <?= htmlspecialchars($config['currencies'][$code]['name']) ?>
                        <!-- –ö–æ–¥ –≤–∞–ª—é—Ç—ã –≤ —Å–∫–æ–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, USD) -->
                        <small>(<?= htmlspecialchars($code) ?>)</small>
                    </span>

                        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã —Å 2 –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π -->
                        <span class="currency-rate">
                        <?= number_format($rate, 2) ?> —Ä—É–±.
                    </span>
                    </div>
                <?php endif; ?>
            <?php endforeach; ?>
        </div>

        <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö -->
        <p class="cache-info">
            <!-- –í—ã–≤–æ–¥–∏–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú:–°–° -->
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: <?= date('H:i:s', $data['updated_at']) ?>
            <!-- –£–∫–∞–∑—ã–≤–∞–µ–º, –æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç—ã –¥–∞–Ω–Ω—ã–µ (–∏–∑ –∫—ç—à–∞ –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ) -->
            <?= $useCache ? '(–∏–∑ –∫—ç—à–∞)' : '(–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)' ?>
        </p>
    <?php else: ?>
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç -->
        <p class="empty-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç.</p>
    <?php endif; ?>

    <?php
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    if (!empty($data['error'])): ?>
        <!-- –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, —ç–∫—Ä–∞–Ω–∏—Ä—É—è —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã -->
        <p class="error-message">–û—à–∏–±–∫–∞: <?= htmlspecialchars($data['error']) ?></p>
    <?php endif; ?>
    </body>
    </html>
    <?php
    // –ó–∞–≤–µ—Ä—à–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π HTML
    return ob_get_clean();
 }
    ?>

